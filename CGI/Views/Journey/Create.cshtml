@using Microsoft.AspNetCore.Mvc.TagHelpers
@model Stopover

@{
    ViewData["Title"] = "Register Journey";
}

<body>
<script>
        async function checkAndCreateJourney() {
            let journeyId = localStorage.getItem('JourneyID');
            let userId = localStorage.getItem('User_ID');
            if (!journeyId) {
                let response = await fetch('/Journey/CreateAndGetJourneyId?userId=' + userId);
                if (response.ok) {
                    let jsonResponse = await response.json();
                    if (jsonResponse.success) {
                        localStorage.setItem('JourneyID', jsonResponse.journeyId);
                    }
                } else {
                    console.error('Failed to create a new journey:', response.statusText);
                }
            }
        }

        window.onload = function () {
            checkAndCreateJourney();
            GetStopovers();
        }

        async function getEmission(vehicleType, distance) {
            let response = await fetch(`/StopOver/CalculateEmission?vehicleType=${vehicleType}&distance=${distance}`);
            if (response.ok) {
                let jsonResponse = await response.json();
                return jsonResponse.emission;
            } else {
                console.error("Failed to get emission:", response.statusText);
                return 0;
            }
        }

        function GetStopovers() {
            let stopovers = JSON.parse(localStorage.getItem('Stopovers')) || [];
            let div = document.getElementById("StopoverList");
            let html = "";
            for (let i = 0; i < stopovers.length; i++) {
                let stopover = stopovers[i];
                html += "<td>" + stopover.start + " - " + stopover.end + " (" + stopover.vehicle + ", " + stopover.distance + "km)" + "</td><br>";
            }
            div.innerHTML = html;

            if (stopovers.length > 0) {
                document.getElementById("submitJourneyBtn").classList.remove("hidden");
                } else {
                document.getElementById("submitJourneyBtn").classList.add("hidden");
            }
        }

        async function submitJourney() {
            let journeyId = localStorage.getItem('JourneyID');
            let userId = localStorage.getItem('User_ID');
            let stopovers = JSON.parse(localStorage.getItem('Stopovers')) || [];
            let vehicleSelect = document.getElementById('vehicle');
            let vehicleType = parseInt(vehicleSelect.value);
            alert('Vehicle Type: ' + vehicleType);



            // Update the journey in the database
            let response = await fetch('/Journey/UpdateJourney?journeyId=' + journeyId + '&userId=' + userId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(stopovers)
            });

            if (response.ok) {
                // Remove stopovers and journey ID from LocalStorage
                localStorage.removeItem('Stopovers');
                localStorage.removeItem('JourneyID');

                // Redirect the user to the Index.cshtml in the Home controller
                window.location.href = '/Home/Index';
            } else {
                console.error('Failed to submit journey:', response.statusText);
            }
        }

        async function AddStopoverToList() {
            let start = document.getElementById('startinglocation').value;
            let end = document.getElementById('endlocation').value;
            let vehicle = document.getElementById('vehicle').value;
            let distance = document.getElementById('distance').value;
            let emission = await getEmission(vehicle, distance);


            if (start != "" || end != "" || distance != 0) {
                let stopovers = JSON.parse(localStorage.getItem('Stopovers')) || [];
                let stopover = {
                    start: start,
                    end: end,
                    vehicle: vehicle,
                    distance: distance,
                    emission: emission
                };
                stopovers.push(stopover);
                localStorage.setItem('Stopovers', JSON.stringify(stopovers));
                GetStopovers();
            }
        }

    </script>
    <div class="flex justify-center items-center h-screen bg-slate-200">
        <div class="block bg-slate-100 p-6 rounded-lg shadow-md shadow-slate-300 w-90 grid grid-cols-2 gap-4">
            <div class=text-lg>Register new stopover:</div>
            <br>
            <div class="block bg-slate-50 p-6 rounded-lg shadow-md shadow-slate-300 w-90 max-h-96">
                <form onsubmit="return AddStopoverToList()">
                    <label>Starting Location:</label>
                    <br>
                    <input asp-for="Start" class="shadow appearance-none border border-black rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="startinglocation" placeholder="Input starting location." required>
                    <label>End Location:</label>
                    <br>
                    <input asp-for="End" class="shadow appearance-none border border-black rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="endlocation" placeholder="Input end location." required>
                    <label>Vehicle:</label>
                    <br>
                    <select id="vehicle" asp-for="VehicleType" asp-items="Html.GetEnumSelectList<Vehicle_ID>()" class="shadow appearance-none border border-black rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    </select>
                    <label>Distance in km:</label>
                    <br>
                    <input asp-for="Distance" class="shadow appearance-none border border-black rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="distance" placeholder="Input distance in km." required>
                    <button class="bg-blue-700 rounded-lg w-full text-white min-h-fit">Add</button>
                </form>
            </div>
            <div class="block bg-slate-50 p-6 rounded-lg shadow-md shadow-slate-300 w-90 flex-none flex-col max-h-96">
                <div>Stopovers:</div>
                <div class="overflow-y-scroll h-5/6" id="StopoverList"></div>
                <button id="submitJourneyBtn" class="bg-green-700 rounded-lg w-full text-white hidden" onclick="submitJourney()">Submit Journey</button>
            </div>
        </div>
    </div>
</body>
