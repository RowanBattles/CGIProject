@using Microsoft.AspNetCore.Mvc.TagHelpers
@model Stopover

@{
    ViewData["Title"] = "Create Stopovers for Journey";
}
<style>
    .stopover-item {
        background: #f8f8f8;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
    }

    .stopover-start, .stopover-end, .stopover-vehicle, .stopover-distance {
        display: block;
        margin-bottom: 5px;
    }
</style>
<body>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
        $(function () {
            // Get the JourneyID from LocalStorage
            var journeyId = localStorage.getItem('JourneyID');

            // Set the value of the hidden field
            $('#journeyId').val(journeyId);

            $("form").on("submit", function (event) {
                event.preventDefault();

                // Get the selected option value
                var vehicleType = $("#vehicle option:selected").val();

                // Set the value of the hidden field to the enum value
                $('#VehicleType').val(vehicleType);

                var formData = $(this).serialize();

                $.post("/StopOver/CreateStopOver", formData, function (response) {
                    if (response.success) {
                        var stopover = response.stopover;
                        var stopoverItem = `
        <div class="stopover-item">
            <span class="stopover-start">Start: ${stopover.start}</span>
            <span class="stopover-end">End: ${stopover.end}</span>
            <span class="stopover-vehicle">Vehicle: ${vehicleType}</span>
            <span class="stopover-distance">Distance: ${stopover.distance}km</span>
        </div>`;

                        $("#StopoverList").append(stopoverItem);
                        $("#submitJourneyBtn").removeClass("hidden");
                        $("form").trigger("reset");
                    } else {
                        alert("Error: Could not create stopover");
                    }
                });
            });

            $("#submitJourneyBtn").on("click", function () {
                // Get the JourneyID from LocalStorage
                var journeyId = localStorage.getItem('JourneyID');
                var userId = localStorage.getItem('User_ID');

                // Send a POST request to submit the journey data to the server
                $.post("/Journey/SubmitJourney", { journeyId: journeyId, userId: userId }, function (response) {
                    if (response.success) {
                        alert("Journey submitted successfully");
                        localStorage.removeItem('JourneyID');
                        window.location.href = '/Journey/Index';
                    } else {
                        alert("Error: Could not submit journey");
                    }
                });
            });
        });

        // Function to check if a journey exists and create one if it doesn't
        async function checkAndCreateJourney() {
            let journeyId = localStorage.getItem('JourneyID');
            let userId = localStorage.getItem('User_ID');
            if (!journeyId) {
                let response = await fetch('/Journey/CreateAndGetJourneyId?userId=' + userId);
                if (response.ok) {
                    let jsonResponse = await response.json();
                    if (jsonResponse.success) {
                        localStorage.setItem('JourneyID', jsonResponse.journeyId);
                    }
                } else {
                    console.error('Failed to create a new journey:', response.statusText);
                }
            }
        }

        window.onload = function() {
            checkAndCreateJourney();
        };
</script>

<!-- Main layout of the page -->
<div class="flex justify-center items-center h-screen bg-slate-200">
    <div class="block bg-slate-100 p-6 rounded-lg shadow-md shadow-slate-300 w-90 grid grid-cols-2 gap-4">
        <div class=text-lg>Register new stopover:</div>
        <br>
        <div class="block bg-slate-50 p-6 rounded-lg shadow-md shadow-slate-300 w-90 max-h-96">
            <!-- Form for adding a new stopover -->
            <form method="post" action="/StopOver/CreateStopOver">
                <input type="hidden" name="journeyId" id="journeyId" value="">
                <!-- Input fields for starting location, end location, vehicle, and distance -->
                <label>Starting Location:</label>
                <br>
                <input asp-for="Start" class="shadow appearance-none border border-black rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="startinglocation" placeholder="Input starting location." required>
                <label>End Location:</label>
                <br>
                <input asp-for="End" class="shadow appearance-none border border-black rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="endlocation" placeholder="Input end location." required>
                <label>Vehicle:</label>
                <br>
                <input type="hidden" asp-for="VehicleType" id="VehicleType"/>
                <select id="vehicle" class="shadow appearance-none border border-black rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" required>
                    @foreach (var item in Html.GetEnumSelectList<Vehicle_ID>())
                    {
                        <option value="@item.Value">@item.Text</option>
                    }
                </select>
                <label>Distance in km:</label>
                <br>
                <input asp-for="Distance" class="shadow appearance-none border border-black rounded w-full py-2 px-3 text-gray-700 mb-3 leading-tight focus:outline-none focus:shadow-outline" id="distance" placeholder="Input distance in km." required>
                <!-- Add button to submit the form -->
                <button class="bg-blue-700 rounded-lg w-full text-white min-h-fit">Add</button>
            </form>
        </div>
        <div class="block bg-slate-50 p-6 rounded-lg shadow-md shadow-slate-300 w-90 flex-none flex-col max-h-96">
            <div>Stopovers:</div>
            <!-- List to display stopovers -->
            <div class="h-5/6" id="StopoverList"></div>
            <button id="submitJourneyBtn" class="bg-green-700 rounded-lg w-full text-white hidden">Submit Journey</button>
        </div>
    </div>
</div>
</body>